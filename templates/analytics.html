<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        :root {
            --bg-page: #faf7f2;
            /* warm sand background */
            --bg-card: #ffffff;
            /* clean card */
            --primary: #d97706;
            /* amber accent */
            --secondary: #92400e;
            /* darker amber */
            --text-main: #3f2f1d;
            /* warm dark brown */
            --text-muted: #7c6f64;
            --border-light: #e7e2da;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: var(--bg-page);
            min-height: 100vh;
            padding: 24px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            color: var(--text-main);
        }

        /* ================= PAGE ================= */
        .page-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ================= HEADER ================= */
        .page-header {
            background: var(--bg-card);
            padding: 24px 30px;
            border-radius: 12px;
            border-left: 6px solid var(--primary);
            margin-bottom: 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-header h1 {
            margin: 0;
            font-size: 26px;
            font-weight: 600;
            color: var(--text-main);
        }

        /* ================= BUTTON ================= */
        .back-btn {
            background: var(--primary);
            color: #ffffff;
            padding: 9px 18px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        .back-btn:hover {
            background: var(--secondary);
        }

        /* ================= CONTENT CARD ================= */
        .content-card {
            background: var(--bg-card);
            padding: 28px;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            margin-bottom: 20px;
        }

        /* ================= KPI ================= */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .kpi-card {
            background: #fffaf3;
            padding: 22px;
            border-radius: 12px;
            border-top: 4px solid var(--primary);
        }

        .kpi-card .icon {
            font-size: 22px;
            margin-bottom: 12px;
            color: var(--primary);
        }

        .kpi-card .label {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .kpi-card .value {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-main);
        }

        /* ================= CHART GRID ================= */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .chart-card h3 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 18px;
            color: var(--text-main);
        }

        /* ================= BAR CHART ================= */
        .chart-bar-item {
            margin-bottom: 16px;
        }

        .chart-bar-header {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .chart-bar-visual {
            background: #e7e2da;
            height: 22px;
            border-radius: 6px;
            overflow: hidden;
        }

        .chart-bar-fill {
            height: 100%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: #ffffff;
            font-size: 12px;
            font-weight: 600;
            transition: width 0.4s ease;
        }
    </style>


</head>

<body>
    <div class="page-container">
        <div class="page-header">
            <h1>üìä Analytics & Reports</h1>
            <a href="/dashboard" class="back-btn">‚Üê Back</a>
        </div>

        <div class="content-card">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="icon">üöó</div>
                    <div class="label">Total Violations</div>
                    <div class="value" id="totalViolations">0</div>
                </div>
                <div class="kpi-card">
                    <div class="icon">üí∞</div>
                    <div class="label">Collection Rate</div>
                    <div class="value" id="collectionRate">0%</div>
                </div>
                <div class="kpi-card">
                    <div class="icon">‚úÖ</div>
                    <div class="label">Paid Violations</div>
                    <div class="value" id="paidCount">0</div>
                </div>
                <div class="kpi-card">
                    <div class="icon">‚è≥</div>
                    <div class="label">Pending Amount</div>
                    <div class="value" id="pendingAmount">‚Çπ0</div>
                </div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-card">
                <h3>üó∫Ô∏è Violations by Area</h3>
                <div id="areaChart">Loading...</div>
            </div>

            <div class="chart-card">
                <h3>üìã Violations by Type</h3>
                <div id="typeChart">Loading...</div>
            </div>

            <div class="chart-card">
                <h3>üí≥ Payment Status</h3>
                <div id="statusChart">Loading...</div>
            </div>

            <div class="chart-card">
                <h3>üìà Collection Efficiency</h3>
                <div id="efficiencyChart">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        window.onload = async function () {
            await loadAnalytics();
        };

        async function loadAnalytics() {
            try {
                // Load collection efficiency
                const effResponse = await fetch('/api/analytics/collection-efficiency');
                const effData = await effResponse.json();
                if (effData.success) {
                    updateKPIs(effData.data);
                    renderEfficiencyChart(effData.data);
                }

                // Load violations by area
                const areaResponse = await fetch('/api/analytics/by-area');
                const areaData = await areaResponse.json();
                if (areaData.success) {
                    renderAreaChart(areaData.data);
                }

                // Load violations by type
                const typeResponse = await fetch('/api/analytics/by-type');
                const typeData = await typeResponse.json();
                if (typeData.success) {
                    renderTypeChart(typeData.data);
                }

                // Load payment status summary
                const response = await fetch('/api/violations');
                const data = await response.json();
                if (data.success) {
                    renderStatusChart(data.data);
                }

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function updateKPIs(data) {
            document.getElementById('totalViolations').textContent = data.total_violations || 0;
            document.getElementById('collectionRate').textContent = (data.collection_percentage || 0) + '%';
            document.getElementById('paidCount').textContent = data.paid_violations || 0;
            document.getElementById('pendingAmount').textContent = '‚Çπ' + (data.pending_amount || 0).toLocaleString();
        }

        function renderAreaChart(data) {
            const container = document.getElementById('areaChart');
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;">No data available</p>';
                return;
            }

            const maxCount = Math.max(...data.map(d => d.violation_count));
            let html = '';

            data.slice(0, 10).forEach(item => {
                const percentage = maxCount > 0 ? (item.violation_count / maxCount * 100) : 0;
                html += `
                    <div class="chart-bar-item">
                        <div class="chart-bar-header">
                            <span>${item.area_name}, ${item.city}</span>
                            <span><strong>${item.violation_count}</strong></span>
                        </div>
                        <div class="chart-bar-visual">
                            <div class="chart-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderTypeChart(data) {
            const container = document.getElementById('typeChart');
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;">No data available</p>';
                return;
            }

            const maxCount = Math.max(...data.map(d => d.occurrence_count));
            let html = '';

            data.slice(0, 10).forEach(item => {
                const percentage = maxCount > 0 ? (item.occurrence_count / maxCount * 100) : 0;
                html += `
                    <div class="chart-bar-item">
                        <div class="chart-bar-header">
                            <span>${item.type_name}</span>
                            <span><strong>${item.occurrence_count}</strong></span>
                        </div>
                        <div class="chart-bar-visual">
                            <div class="chart-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderStatusChart(violations) {
            const container = document.getElementById('statusChart');

            const statusCounts = {
                paid: violations.filter(v => v.status === 'paid').length,
                unpaid: violations.filter(v => v.status === 'unpaid').length,
                disputed: violations.filter(v => v.status === 'disputed').length
            };

            const total = violations.length;
            let html = '';

            Object.entries(statusCounts).forEach(([status, count]) => {
                const percentage = total > 0 ? (count / total * 100) : 0;
                html += `
                    <div class="chart-bar-item">
                        <div class="chart-bar-header">
                            <span>${status.toUpperCase()}</span>
                            <span><strong>${count}</strong> (${percentage.toFixed(1)}%)</span>
                        </div>
                        <div class="chart-bar-visual">
                            <div class="chart-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderEfficiencyChart(data) {
            const container = document.getElementById('efficiencyChart');

            const metrics = [
                { label: 'Total Fines', value: data.total_fines || 0, max: data.total_fines || 1 },
                { label: 'Collected', value: data.collected_amount || 0, max: data.total_fines || 1 },
                { label: 'Pending', value: data.pending_amount || 0, max: data.total_fines || 1 }
            ];

            let html = '';
            metrics.forEach(metric => {
                const percentage = metric.max > 0 ? (metric.value / metric.max * 100) : 0;
                html += `
                    <div class="chart-bar-item">
                        <div class="chart-bar-header">
                            <span>${metric.label}</span>
                            <span><strong>‚Çπ${metric.value.toLocaleString()}</strong></span>
                        </div>
                        <div class="chart-bar-visual">
                            <div class="chart-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
    </script>
</body>

</html>